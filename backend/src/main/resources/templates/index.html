<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DevConnect - 개발자를 위한 서비스</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background-color: #f4f4f9;
    }
    .content {
      flex: 1;
      padding: 20px;
    }
    .banner {
      background-color: #007bff;
      color: white;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
    }
    footer {
      background-color: #f8f9fa;
      padding: 10px;
      text-align: center;
      border-top: 1px solid #dee2e6;
    }
    .contact-info {
      margin-top: 10px;
    }
    .alert {
      display: none;
    }
    .project {
      background-color: #e7f3fe;
      border-left: 5px solid #2196F3;
    }
    .study {
      background-color: #fce4ec;
      border-left: 5px solid #E91E63;
    }
    .pagination {
      margin-top: 20px;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">DevConnect</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link" href="/">홈</a>
        </li>
      </ul>
      <ul class="navbar-nav" id="authNav">
        <li class="nav-item" id="welcomeMessage" style="display: none;"></li>
        <li class="nav-item" id="logoutItem" style="display: none;">
          <a class="nav-link" href="#" id="logoutButton">로그아웃</a>
        </li>
        <li class="nav-item" id="loginItem" style="display: none;">
          <a class="nav-link" href="/login">로그인</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="content container">
  <div class="banner text-center">
    <h1>안녕하세요, 개발자 여러분!</h1>
  </div>

  <div id="errorBanner" class="alert alert-danger">
    <span id="errorMessage"></span>
    <button id="retryButton" class="btn btn-link">로그인 페이지로 이동</button>
  </div>

  <div id="guestContent" style="display: none;">
    <section class="mt-5">
      <h2>DevConnect 소개</h2>
      <p>DevConnect는 개발자들을 위한 스터디, 팀 프로젝트 모집, 채용공고 정보를 제공하는 플랫폼입니다. 커뮤니티에 참여하고 함께 성장하세요!</p>
      <p>로그인 후 다양한 기능을 이용해 보세요!</p>
    </section>
  </div>

  <div id="userContent" style="display: none;">
    <section class="mt-5">
      <h2>관심 채용 공고</h2>
      <ul class="list-group" id="interestJobListings"></ul>
    </section>

    <section class="mt-5">
      <h2>관심 스터디/프로젝트</h2>
      <ul class="list-group">
        <li class="list-group-item">스터디/프로젝트 1</li>
        <li class="list-group-item">스터디/프로젝트 2</li>
        <li class="list-group-item">스터디/프로젝트 3</li>
      </ul>
    </section>
  </div>

  <section class="mt-5" id="allProjectsSection">
    <h2>전체 스터디/팀 프로젝트</h2>
    <ul class="list-group" id="allProjectsList"></ul>
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center" id="pagination">
        <li class="page-item"><a class="page-link" href="#" id="prevPage">이전</a></li>
        <li class="page-item"><a class="page-link" href="#" id="nextPage">다음</a></li>
      </ul>
    </nav>
  </section>

  <section class="mt-5">
    <h2>전체 채용 공고</h2>
    <ul class="list-group" id="jobListingsList"></ul>
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center" id="jobPagination">
        <li class="page-item"><a class="page-link" href="#" id="jobPrevPage">이전</a></li>
        <li class="page-item"><a class="page-link" href="#" id="jobNextPage">다음</a></li>
      </ul>
    </nav>
  </section>
</div>

<footer>
  <p>&copy; 2024 DevConnect. 모든 권리 보유.</p>
  <div class="contact-info">
    <p>문의 사항이 있으시면 아래 연락처로 문의해 주세요.</p>
    <p>이메일: <a href="mailto:support@devconnect.com">support@devconnect.com</a></p>
    <p>전화: <a href="tel:010-1234-5678">010-1234-5678</a></p>
  </div>
</footer>

<script>
  let currentProjectsPage = 1;
  const projectsPerPage = 5;
  let currentJobPage = 1;
  const jobsPerPage = 5;

  function showErrorBanner(message) {
    document.getElementById('errorMessage').innerText = message;
    document.getElementById('errorBanner').style.display = 'block';
    document.getElementById('loginItem').style.display = 'block';
  }

  async function fetchUserInfo() {
    const token = localStorage.getItem('token');

    if (token) {
      try {
        const response = await axios.get('/api/v1/members', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        const nickname = response.data.nickname;
        document.getElementById('logoutItem').style.display = 'block';
        document.getElementById('welcomeMessage').innerText = `환영합니다, ${nickname}!`;
        document.getElementById('welcomeMessage').style.display = 'block';
        document.getElementById('userContent').style.display = 'block';
        fetchAllProjects(currentProjectsPage);
        fetchJobListings(currentJobPage);
      } catch (error) {
        console.error('사용자 정보 로드 실패:', error);
        const errorMessage = error.response?.data?.message || '사용자 정보를 로드하는 데 실패했습니다.';
        showErrorBanner(errorMessage);
      }
    } else {
      document.getElementById('guestContent').style.display = 'block';
      document.getElementById('loginItem').style.display = 'block';
    }
  }

  async function fetchAllProjects(page = 1) {
    try {
      const response = await axios.get(`/api/v1/boards?page=${page - 1}&size=${projectsPerPage}`);
      const projects = response.data.content;
      const totalPages = response.data.totalPages;

      const allProjectsList = document.getElementById('allProjectsList');
      allProjectsList.innerHTML = '';

      projects.forEach(item => {
        const listItem = document.createElement('li');
        listItem.className = 'list-group-item ' + (item.type === 'project' ? 'project' : 'study');

        // 상세 페이지로 이동하는 링크 추가
        listItem.innerHTML = `
        <a href="/boards/${item.boardId}" class="text-decoration-none">
          <strong>${item.title}</strong> (${item.category})<br>
          작성자: ${item.author}<br>
          모집 인원: ${item.recruitNum}<br>
          진행 방식: ${item.progressWay}<br>
          마감일: ${new Date(item.endDate).toLocaleDateString()}<br>
          상태: ${item.status}
        </a>
      `;

        allProjectsList.appendChild(listItem);
      });

      document.getElementById('prevPage').style.display = page > 1 ? 'inline' : 'none';
      document.getElementById('nextPage').style.display = page < totalPages ? 'inline' : 'none';

    } catch (error) {
      console.error('프로젝트 로드 실패:', error);
      showErrorBanner('프로젝트를 로드하는 데 실패했습니다.');
    }
  }

  async function fetchJobListings(page = 1) {
    try {
      const response = await axios.get(`/api/v1/job-posts?page=${page - 1}&size=${jobsPerPage}`);
      const jobListings = response.data.content;
      const totalPages = response.data.totalPages;

      const jobListingsList = document.getElementById('jobListingsList');
      jobListingsList.innerHTML = '';

      jobListings.forEach(job => {
        const listItem = document.createElement('li');
        listItem.className = 'list-group-item';

        // 상세 페이지로 이동하는 링크 추가
        listItem.innerHTML = `
        <a href="/job-posts/${job.job_post_id}" class="text-decoration-none">
          <strong>${job.job_post_name}</strong><br>
          회사: ${job.company_name}<br>
          주소: ${job.company_address}<br>
          공고 시작일: ${new Date(job.open_date).toLocaleDateString()}<br>
          마감일: ${new Date(job.end_date).toLocaleDateString()}<br>
          급여: ${job.salary}<br>
          상태: ${job.status}<br>
          조회수: ${job.views} | 좋아요: ${job.likes}
        </a>
      `;

        jobListingsList.appendChild(listItem);
      });

      document.getElementById('jobPrevPage').style.display = page > 1 ? 'inline' : 'none';
      document.getElementById('jobNextPage').style.display = page < totalPages ? 'inline' : 'none';

    } catch (error) {
      console.error('채용 공고 로드 실패:', error);
      showErrorBanner('채용 공고를 로드하는 데 실패했습니다.');
    }
  }


  document.getElementById('prevPage').addEventListener('click', (event) => {
    event.preventDefault();
    if (currentProjectsPage > 1) {
      currentProjectsPage--;
      fetchAllProjects(currentProjectsPage);
    }
  });

  document.getElementById('nextPage').addEventListener('click', (event) => {
    event.preventDefault();
    currentProjectsPage++;
    fetchAllProjects(currentProjectsPage);
  });

  document.getElementById('jobPrevPage').addEventListener('click', (event) => {
    event.preventDefault();
    if (currentJobPage > 1) {
      currentJobPage--;
      fetchJobListings(currentJobPage);
    }
  });

  document.getElementById('jobNextPage').addEventListener('click', (event) => {
    event.preventDefault();
    currentJobPage++;
    fetchJobListings(currentJobPage);
  });

  async function logout() {
    const token = localStorage.getItem('token');

    if (token) {
      try {
        await axios.post('/api/v1/members/logout', {}, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        localStorage.removeItem('token');
        window.location.href = '/';
      } catch (error) {
        console.error('로그아웃 실패:', error);
        alert('로그아웃에 실패했습니다. 다시 시도해 주세요.');
      }
    }
  }

  document.getElementById('logoutButton').addEventListener('click', (event) => {
    event.preventDefault();
    logout();
  });

  document.getElementById('retryButton').addEventListener('click', () => {
    window.location.href = '/login';
  });

  fetchUserInfo();
</script>
</body>
</html>
