<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>게시물 상세 조회</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-5">
  <h2 class="mb-4">게시물 상세 정보</h2>
  <div id="boardDetail" class="card">
    <div class="card-header">
      <h3 id="boardTitle">게시물 제목</h3>
      <small>작성자: <span id="boardAuthor">작성자 이름</span></small>
    </div>
    <div class="card-body">
      <p class="card-text" id="boardContent">게시물 내용</p>
      <hr>
      <p>카테고리: <span id="boardCategory">카테고리</span></p>
      <p>진행 방식: <span id="boardProgressWay">진행 방식</span></p>
      <p>조회수: <span id="boardViews">조회수</span></p>
      <p>좋아요 수: <span id="boardLikes">좋아요 수</span></p>
      <p>작성일: <span id="boardCreatedDate">작성일</span></p>
      <p>마감일: <span id="boardEndDate">마감일</span></p>
    </div>
    <div class="card-footer">
      <button class="btn btn-primary" id="editButton">수정</button>
      <button class="btn btn-danger" id="deleteButton">삭제</button>
      <!-- 관심 등록 및 해제 버튼 -->
      <button class="btn btn-warning" id="interestButton" onclick="toggleInterest()">관심 목록에 추가</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  const boardId = window.location.pathname.split('/').pop(); // URL에서 boardId 추출
  let isInterested = false; // 사용자가 이미 관심 목록에 있는지 여부

  // 게시물 정보를 가져오는 함수
  async function fetchBoardDetail() {
    try {
      const response = await axios.get(`/api/v1/boards/${boardId}`);
      const board = response.data;

      // 데이터 업데이트
      document.getElementById('boardTitle').innerText = board.title;
      document.getElementById('boardAuthor').innerText = board.author;
      document.getElementById('boardContent').innerText = board.content;
      document.getElementById('boardCategory').innerText = board.category;
      document.getElementById('boardProgressWay').innerText = board.progressWay;
      document.getElementById('boardViews').innerText = board.views;
      document.getElementById('boardLikes').innerText = board.likes;
      document.getElementById('boardCreatedDate').innerText = new Date(board.createdDate).toLocaleDateString();
      document.getElementById('boardEndDate').innerText = new Date(board.endDate).toLocaleDateString();

      // 관심 여부 확인 후 상태 업데이트
      checkInterestStatus();
    } catch (error) {
      console.error('게시물 정보를 가져오는 중 오류가 발생했습니다.', error);
    }
  }

  // 관심 등록 상태 확인 함수
  async function checkInterestStatus() {
    try {
      const response = await axios.get(`/api/v1/interests`, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });

      const interestBoards = response.data.interestBoards;
      isInterested = interestBoards.some(board => board.boardId === Number(boardId));

      // 버튼 텍스트 변경
      document.getElementById('interestButton').innerText = isInterested ? '관심 목록에서 해제' : '관심 목록에 추가';
    } catch (error) {
      console.error('관심 목록 확인 실패:', error);
    }
  }

  // 관심 목록에 추가 또는 해제하는 함수
  async function toggleInterest() {
    try {
      const token = localStorage.getItem('token');

      if (!token) {
        alert('로그인이 필요합니다.');
        return;
      }

      if (isInterested) {
        // 관심 목록에서 삭제
        await axios.delete(`/api/v1/interests/boards/${boardId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        alert('관심 목록에서 삭제되었습니다.');
        isInterested = false;
      } else {
        // 관심 목록에 추가 (Snake Case로 board_id 전송)
        await axios.post('/api/v1/interests/boards', { board_id: boardId }, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        alert('관심 목록에 추가되었습니다.');
        isInterested = true;
      }

      // 버튼 텍스트 업데이트
      document.getElementById('interestButton').innerText = isInterested ? '관심 목록에서 해제' : '관심 목록에 추가';

    } catch (error) {
      console.error('관심 목록 처리 중 오류 발생:', error);
      alert('관심 목록 처리 중 오류가 발생했습니다.');
    }
  }


  // 게시물 삭제 함수
  async function deleteBoard() {
    if (confirm('정말로 삭제하시겠습니까?')) {
      try {
        await axios.delete(`/api/v1/boards/${boardId}`);
        alert('게시물이 삭제되었습니다.');
        window.location.href = '/boards';  // 게시물 목록으로 리다이렉트
      } catch (error) {
        console.error('게시물 삭제 실패:', error);
        alert('게시물 삭제에 실패했습니다.');
      }
    }
  }

  // 수정 페이지로 이동
  document.getElementById('editButton').addEventListener('click', () => {
    window.location.href = `/boards/edit/${boardId}`;
  });

  // 페이지 로드 시 게시물 상세 정보 가져오기
  fetchBoardDetail();
</script>
</body>
</html>
